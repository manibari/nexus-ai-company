# 產品部署標準規範

**版本：** 1.0
**建立日期：** 2026-02-07
**來源：** CR-003 架構改進

---

## 1. 核心原則

### 1.1 分離原則

> **所有對外產品必須與 Nexus 核心系統分離部署**

```
✅ 正確                              ❌ 錯誤
┌──────────┐  ┌──────────┐          ┌──────────────────────┐
│  Nexus   │  │ Product  │          │ Nexus + Product      │
│  System  │  │    A     │          │ (混在一起)            │
└──────────┘  └──────────┘          └──────────────────────┘
獨立部署       獨立部署                共用環境
```

### 1.2 環境分離

每個產品必須具備以下環境：

| 環境 | 用途 | 存取權限 |
|------|------|----------|
| Development | 開發測試 | 開發團隊 |
| Staging | QA/UAT | 測試團隊 + CEO |
| Production | 正式服務 | 終端用戶 |

### 1.3 網域獨立

- 每個產品擁有獨立網域或子網域
- 不得使用 Nexus 系統的網域
- Production 環境必須使用 HTTPS

---

## 2. 產品分類與部署要求

### 2.1 分類標準

| 類型 | 定義 | 部署要求 |
|------|------|----------|
| **內部工具** | 僅供 Nexus Agent 使用 | 可與 Nexus 整合 |
| **內部產品** | 供 CEO/內部人員使用 | 獨立埠，可本地部署 |
| **外部產品** | 供終端用戶使用 | 必須獨立部署+獨立網域 |

### 2.2 部署要求矩陣

| 要求 | 內部工具 | 內部產品 | 外部產品 |
|------|----------|----------|----------|
| 獨立程式碼庫 | 選用 | 建議 | **必須** |
| 獨立部署環境 | 選用 | **必須** | **必須** |
| 獨立網域 | 不需要 | 選用 | **必須** |
| SSL 憑證 | 不需要 | 建議 | **必須** |
| CI/CD Pipeline | 選用 | 建議 | **必須** |
| 監控告警 | 選用 | 建議 | **必須** |

---

## 3. PM 規劃階段要求

### 3.1 PRD 必須包含

```markdown
## X. 部署需求

### X.1 產品分類
- [ ] 內部工具
- [ ] 內部產品
- [ ] 外部產品

### X.2 部署環境需求
- Development: ___
- Staging: ___
- Production: ___

### X.3 網域需求
- 建議網域: ___
- 備選網域: ___

### X.4 基礎設施預估
- Compute: ___
- Database: ___
- 月成本預估: ___
```

### 3.2 技術設計必須包含

```markdown
## X. 部署架構

### X.1 系統架構圖
（含部署環境）

### X.2 容器化方案
- Dockerfile
- docker-compose.yml

### X.3 CI/CD Pipeline
- Build
- Test
- Deploy

### X.4 環境變數管理
- 敏感資訊處理
- 環境差異配置
```

### 3.3 必須建立的文件

| 階段 | 文件 | 範本 |
|------|------|------|
| 規劃 | `02_planning/deployment_plan.md` | 見附錄 A |
| 實作 | `03_execution/deployment_checklist.md` | 見附錄 B |
| 結案 | `05_closing/operations_manual.md` | 見附錄 C |

---

## 4. 部署階段流程

### 4.1 標準部署流程

```
┌─────────────────────────────────────────────────────────────┐
│                      部署階段流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 準備階段                                                 │
│     ├── 確認程式碼已合併至 main branch                       │
│     ├── 確認所有測試通過                                     │
│     └── 確認部署檢查清單已完成                               │
│                                                             │
│  2. 環境建置                                                 │
│     ├── 建立/確認基礎設施                                    │
│     ├── 設定環境變數                                         │
│     └── 設定網域 DNS                                         │
│                                                             │
│  3. 部署執行                                                 │
│     ├── 部署後端服務                                         │
│     ├── 部署前端服務                                         │
│     └── 設定 SSL 憑證                                        │
│                                                             │
│  4. 驗證階段                                                 │
│     ├── 健康檢查（Health Check）                             │
│     ├── 功能驗證（Smoke Test）                               │
│     └── 效能驗證（Load Test - 選用）                         │
│                                                             │
│  5. 上線                                                     │
│     ├── DNS 切換（如需要）                                   │
│     ├── 通知相關人員                                         │
│     └── 監控觀察                                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 部署檢查清單

```markdown
## 部署前檢查
- [ ] 程式碼已通過所有測試
- [ ] 程式碼已合併至 main branch
- [ ] 環境變數已設定
- [ ] 資料庫 migration 已準備（如需要）
- [ ] 備份已建立（如需要）

## 部署中檢查
- [ ] 後端服務已啟動
- [ ] 前端服務已啟動
- [ ] SSL 憑證已設定
- [ ] 健康檢查端點回應正常

## 部署後檢查
- [ ] 核心功能可正常使用
- [ ] 日誌無錯誤
- [ ] 監控已啟用
- [ ] 通知已發送
```

---

## 5. 基礎設施建議

### 5.1 MVP/小規模專案

| 選項 | 適用規模 | 月成本 | 優點 | 缺點 |
|------|----------|--------|------|------|
| **DigitalOcean Droplet** | < 1000 用戶 | $12-24 | 簡單、便宜 | 手動擴展 |
| **Render** | < 5000 用戶 | $0-25 | 自動部署 | 冷啟動 |
| **Railway** | < 5000 用戶 | $5-20 | 開發友好 | 限制較多 |
| **Fly.io** | < 10000 用戶 | $0-30 | 全球邊緣 | 學習曲線 |

### 5.2 中大規模專案

| 選項 | 適用規模 | 月成本 | 優點 | 缺點 |
|------|----------|--------|------|------|
| **AWS ECS/Fargate** | 任意 | $50+ | 彈性擴展 | 複雜 |
| **GCP Cloud Run** | 任意 | $30+ | Serverless | 冷啟動 |
| **Kubernetes** | 大規模 | $100+ | 完全控制 | 維運複雜 |

### 5.3 本地開發建議

```yaml
# 標準 docker-compose.yml 結構
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "${BACKEND_PORT:-4001}:8000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
    volumes:
      - ./backend:/app

  frontend:
    build: ./frontend
    ports:
      - "${FRONTEND_PORT:-4000}:80"
    depends_on:
      - backend

  # 選用服務
  db:
    image: postgres:15
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine

volumes:
  pgdata:
```

---

## 6. 網域規劃指南

### 6.1 命名慣例

| 環境 | 格式 | 範例 |
|------|------|------|
| Production | `{product}.com` | stockpulse.com |
| Staging | `staging.{product}.com` | staging.stockpulse.com |
| Development | `dev.{product}.com` 或 localhost | localhost:4000 |

### 6.2 子網域規劃

| 子網域 | 用途 |
|--------|------|
| `www.` | 主要網站（redirect 到裸域） |
| `api.` | API 端點 |
| `app.` | Web 應用程式 |
| `docs.` | 文件網站 |
| `status.` | 狀態頁面 |

---

## 7. 更新紀錄

| 版本 | 日期 | 變更內容 | 作者 |
|------|------|----------|------|
| 1.0 | 2026-02-07 | 初版建立 | PM Agent |

---

## 附錄 A: 部署規劃書範本

```markdown
# [專案名稱] 部署規劃書

## 1. 基本資訊

| 項目 | 內容 |
|------|------|
| 專案名稱 | |
| 產品分類 | 內部工具 / 內部產品 / 外部產品 |
| 預計上線日期 | |
| 負責人 | |

## 2. 環境規劃

| 環境 | URL | 基礎設施 | 用途 |
|------|-----|----------|------|
| Development | localhost:XXXX | 本地 | 開發 |
| Staging | staging.xxx.com | | QA/UAT |
| Production | xxx.com | | 正式 |

## 3. 基礎設施

### 3.1 Compute
| 資源 | 規格 | 數量 | 月成本 |
|------|------|------|--------|
| | | | |

### 3.2 Database
| 類型 | 規格 | 用途 | 月成本 |
|------|------|------|--------|
| | | | |

### 3.3 其他服務
| 服務 | 用途 | 月成本 |
|------|------|--------|
| | | |

### 3.4 總成本預估
| 項目 | 月成本 |
|------|--------|
| 總計 | |

## 4. 網域規劃

| 網域 | 用途 | DNS 設定 |
|------|------|----------|
| | | |

## 5. CI/CD Pipeline

### 5.1 Build
...

### 5.2 Test
...

### 5.3 Deploy
...

## 6. 環境變數

| 變數名 | 用途 | 敏感 |
|--------|------|------|
| | | |

## 7. 監控與告警

| 監控項目 | 工具 | 告警條件 |
|----------|------|----------|
| | | |

## 8. 備份策略

| 項目 | 頻率 | 保留期限 |
|------|------|----------|
| | | |

## 9. 簽核

| 角色 | 日期 | 簽核 |
|------|------|------|
| PM | | |
| SWE | | |
| CEO | | |
```

---

## 附錄 B: 部署檢查清單範本

（見上方 4.2 節）

---

## 附錄 C: 維運手冊範本

```markdown
# [專案名稱] 維運手冊

## 1. 系統概覽
...

## 2. 存取資訊
...

## 3. 日常維運
### 3.1 健康檢查
### 3.2 日誌查看
### 3.3 效能監控

## 4. 故障排除
### 4.1 常見問題
### 4.2 緊急聯絡

## 5. 備份與還原
### 5.1 備份程序
### 5.2 還原程序

## 6. 更新部署
### 6.1 標準更新流程
### 6.2 回滾程序
```
