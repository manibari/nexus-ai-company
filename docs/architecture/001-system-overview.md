# 001: 系統架構總覽

> **版本**: 1.0.0
> **日期**: 2026-02-06

---

## 架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                        FRONTEND (React)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  RPG Map    │  │  HUD/KPI    │  │  Inbox (CEO Decisions)  │  │
│  │  (Canvas)   │  │  Dashboard  │  │  - Approvals            │  │
│  └─────────────┘  └─────────────┘  │  - UAT Reviews          │  │
│                                     └─────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                             │ WebSocket + REST API
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      BACKEND (FastAPI)                          │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    API Layer (/api/v1)                    │   │
│  │  - GET /agents          - POST /agents/{id}/action       │   │
│  │  - GET /tasks           - POST /ceo/approve              │   │
│  │  - WS /events           - GET /dashboard/kpi             │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              │                                   │
│  ┌───────────────────────────┴───────────────────────────────┐  │
│  │                     Agent Orchestrator                     │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │  │
│  │  │  Sales  │ │   PM    │ │   Eng   │ │   QA    │  ...     │  │
│  │  │  Agent  │ │  Agent  │ │  Agent  │ │  Agent  │          │  │
│  │  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘          │  │
│  │       └───────────┴───────────┴───────────┘               │  │
│  │                        │                                   │  │
│  │              ┌─────────┴─────────┐                        │  │
│  │              │    Message Bus    │                        │  │
│  │              │  (Agent-to-Agent) │                        │  │
│  │              └───────────────────┘                        │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│  ┌───────────────────────────┴───────────────────────────────┐  │
│  │                     LLM Provider Layer                     │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                 │  │
│  │  │  Gemini  │  │  Claude  │  │  OpenAI  │                 │  │
│  │  │ Adapter  │  │ Adapter  │  │ Adapter  │                 │  │
│  │  └──────────┘  └──────────┘  └──────────┘                 │  │
│  └───────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                             │ SQLAlchemy ORM
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      DATABASE (SQLite)                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │  agents  │  │  tasks   │  │   logs   │  │  ledger  │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
└─────────────────────────────────────────────────────────────────┘
```

---

## 資料流

### 1. Agent 執行週期

```
┌──────────────────────────────────────────────────────────┐
│                    Agent Think Loop                       │
│                                                           │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌──────┐  │
│   │  Sense  │───▶│  Think  │───▶│   Act   │───▶│ Log  │  │
│   │ (讀DB)  │    │ (LLM)   │    │ (Tools) │    │(寫DB)│  │
│   └─────────┘    └─────────┘    └─────────┘    └──────┘  │
│        ▲                                           │      │
│        └───────────────────────────────────────────┘      │
└──────────────────────────────────────────────────────────┘
```

### 2. CEO 決策流程

```
Agent 遇到權限不足
        │
        ▼
  建立 Blocking Task
  (status: BLOCKED_USER)
        │
        ▼
  推送到 CEO Inbox
  (WebSocket event)
        │
        ▼
  CEO 在前端審批
        │
        ▼
  POST /ceo/approve
        │
        ▼
  解除 Blocking
  Agent 繼續執行
```

---

## 核心模組說明

| 模組 | 路徑 | 職責 |
|------|------|------|
| API Layer | `backend/app/api/` | 處理 HTTP/WebSocket 請求 |
| Agent Classes | `backend/app/agents/` | 各 Agent 的思考邏輯 |
| LLM Providers | `backend/app/llm/` | 抽象化 LLM 調用 |
| Pipelines | `backend/app/pipelines/` | 狀態機轉換邏輯 |
| Database | `backend/app/db/` | SQLAlchemy Models |

---

## 通訊協定

### REST API

- 用於：CRUD 操作、CEO 決策
- 格式：JSON
- 認證：MVP 階段暫無（本地運行）

### WebSocket

- 用於：即時狀態推送、RPG 畫面更新
- 事件類型：
  - `agent.status_changed`
  - `task.stage_changed`
  - `inbox.new_item`
  - `kpi.updated`

---

## 參考文件

- [ADR-001-tech-stack.md](../decisions/ADR-001-tech-stack.md)
- [002-llm-abstraction.md](./002-llm-abstraction.md)
